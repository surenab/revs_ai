# Testing environment Docker Compose
# Usage: docker-compose -f docker-compose.yml -f docker-compose.testing.yml up

version: '3.8'

services:
  test:
    build:
      context: .
      dockerfile: Dockerfile
      target: testing
    environment:
      - DJANGO_SETTINGS_MODULE=config.settings.testing
      - DEBUG=True
    volumes:
      - .:/app
      - /app/.venv
    command: >
      sh -c "python manage.py migrate &&
             pytest --cov=. --cov-report=html --cov-report=term --cov-report=xml"
    depends_on:
      - test_db

  test_db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=test_stocks
      - POSTGRES_USER=test_user
      - POSTGRES_PASSWORD=test_pass
    tmpfs:
      - /var/lib/postgresql/data  # Use tmpfs for faster tests

  # Linting and code quality
  lint:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    volumes:
      - .:/app
    command: >
      sh -c "ruff check --show-fixes &&
             ruff format --check"

  # Security scanning
  safety:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    volumes:
      - .:/app
    command: >
      sh -c "uv add safety &&
             safety check"

  # Type checking (if using mypy)
  mypy:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    volumes:
      - .:/app
    command: >
      sh -c "uv add mypy django-stubs djangorestframework-stubs &&
             mypy ."

# No persistent volumes needed for testing
